---
title: "p8105_hw5_yw3095"
author: "Yixuan Wang"
date: "November 9, 2018"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 6,
                      fig.asp = .6,
                      out.width = "90%")
library(tidyverse)
library(rvest)
library(stats)
```

##Problem 1

Create a tidy dataframe containing data from all participants in a longitudinal study that included a control arm and an experimental arm.

```{r}
read_csv_data = function(x) {
  read_csv(x) %>% 
    mutate(subject = x)
}

file_list = list.files("./data/") %>% paste0("./data/", .)

hw5 = map_dfr(file_list, read_csv_data) %>%
  separate(subject, into = c("remove1", "remove2", "subject"), sep = "\\/") %>% 
  separate(subject, into = c("subject", "remove3"), sep = "\\.") %>%
  mutate(group = subject) %>% 
  separate(group, into = c("group", "remove4"), sep = "_") %>%
  gather(key = week, value = result, week_1:week_8) %>% 
  separate(week, into = c("remove5", "week"), sep = "_") %>%
  mutate(week = as.numeric(week)) %>% 
  select(subject, group, week, result) %>% 
  janitor::clean_names() 
  head(hw5)
```
```{r, fig.width = 6, fig.asp = .8}
ggplot(hw5, aes(x = week, y = result, color = subject)) + 
  geom_line() +
  facet_grid(. ~ group) +
  labs(
    title = "Observations Changes on Each Subject Over Time",
    x = "Week",
    y = "Result") + 
  theme_set(theme_bw() + 
  theme(legend.position = "bottom"))
```
```{r}
hw5 %>% 
  group_by(group, week) %>% 
  summarise(mean_result = mean(result)) %>% 
  knitr::kable(digits = 1)
```
At week 1, control group and exposure group had the similar value of observations, which were about 1. The observations of subjects in control group kept around value 1 over 8 weeks, while the observations of subjects in exposure group increased over time from 1 to 5.


##Problem 2

This problem focus on data on homicides in 50 large U.S. cities.

```{r}
homicide = read_csv(file = "./data2/homicide.csv") %>% 
  janitor::clean_names() 
  skimr::skim(homicide)
```

```{r}
summary = homicide %>% 
  mutate(city_state = paste(city, state, sep = ", ")) %>% 
  group_by(city_state, disposition) %>% 
  summarize(num_homicide = n())

summary = summary %>% 
  spread(key = disposition, value = num_homicide) %>%
  janitor::clean_names() %>% 
  mutate(total_homicide = closed_by_arrest + closed_without_arrest + open_no_arrest,
         unsolved_homicide = closed_without_arrest + open_no_arrest,
         total_homicide = as.numeric(total_homicide),
         unsolved_homicide = as.numeric(unsolved_homicide)) %>% 
  filter(!is.na(total_homicide) | !is.na(unsolved_homicide)) %>% 
  select(city_state, total_homicide, unsolved_homicide) 
```
```{r}
summary %>% 
  filter(city_state == "Baltimore, MD") 
  output = prop.test(1825, 2827, correct = TRUE)
  broom::tidy(output) %>% 
    janitor::clean_names() %>% 
    select(estimate, conf_low, conf_high) %>% 
    knitr::kable(digits = 3)
```
```{r}
prop_test = function(x){
  
  city_test = 
    summary %>% 
    filter(city_state == x)
  
  prop.test(city_test$unsolved_homicide, city_test$total_homicide) %>% 
    broom::tidy() %>% 
    select(estimate, conf.low, conf.high)
}

city_prop = 
  tibble(city_state = summary$city_state) %>% 
  mutate(map(.x = summary$city_state, ~prop_test(.x))) %>% 
  unnest

```


